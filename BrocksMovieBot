import discord
from discord import app_commands
from discord.ext import commands
import requests
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import os
from rapidfuzz import fuzz, process

DISCORD_BOT_TOKEN = os.getenv('DISCORD_BOT_TOKEN')
TMDB_API_KEY = os.getenv('TMDB_API_KEY')
GOOGLE_CREDS_FILE = 'google-creds.json'

# Google Sheets setup
scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
creds = ServiceAccountCredentials.from_json_keyfile_name(GOOGLE_CREDS_FILE, scope)
client = gspread.authorize(creds)

def fetch_movie_details(title):
    """Fuzzy search TMDb + get popularity-weighted best match"""
    search_url = f"https://api.themoviedb.org/3/search/movie?api_key={TMDB_API_KEY}&query={title.replace(' ', '%20')}&language=en-US"
    response = requests.get(search_url)
    
    if response.status_code != 200:
        return None
    
    movies = response.json().get('results', [])
    if not movies:
        return None
    
    # Score by fuzzy match + popularity
    scored_results = []
    for movie in movies:
        candidate_title = movie.get('title', '').lower()
        similarity = fuzz.ratio(title.lower(), candidate_title)
        popularity = movie.get('popularity', 0)
        combined_score = similarity * 0.7 + popularity * 30  # Weight popularity
        
        scored_results.append((combined_score, movie))
    
    # Best match above threshold
    best_score, best_movie = max(scored_results)
    if best_score > 75:
        movie_id = best_movie['id']
        detail_url = f"https://api.themoviedb.org/3/movie/{movie_id}?api_key={TMDB_API_KEY}&language=en-US&append_to_response=credits,release_dates"
        detail_response = requests.get(detail_url)
        
        if detail_response.status_code == 200:
            details = detail_response.json()
            
            # Extract age rating (US MPAA)
            age_rating = 'N/A'
            release_dates = details.get('release_dates', {}).get('results', [])
            for date_info in release_dates:
                if date_info.get('iso_3166_1') == 'US':
                    certification = date_info.get('certification', '')
                    if certification:
                        age_rating = certification
                        break
            
            # Directors/actors
            directors = [crew['name'] for crew in details.get('credits', {}).get('crew', []) if crew['job'] == 'Director'][:2]
            actors = [cast['name'] for cast in details.get('credits', {}).get('cast', [])][:3]
            
            return {
                'title': details.get('title'),
                'release_year': details.get('release_date', '')[:4],
                'age_rating': age_rating,
                'directors': ', '.join(directors) or 'N/A',
                'actors': ', '.join(actors) or 'N/A'
            }
    return None

def check_watchlist_fuzzy(movie_title, watchlist_data):
    """Fuzzy match against watchlist titles in Google Sheet"""
    titles = [row[0].strip().lower() for row in watchlist_data[1:] if row and row[0]]  # Skip header
    
    if not titles:
        return False, None, 0
    
    best_match, score = process.extractOne(movie_title.lower(), titles, scorer=fuzz.ratio)
    return score > 85, best_match, score

intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix='!', intents=intents)

@bot.event
async def on_ready():
    print(f'{bot.user} has logged in!')
    try:
        synced = await bot.tree.sync()
        print(f'Synced {len(synced)} command(s)')
    except Exception as e:
        print(f'Failed to sync: {e}')

@bot.tree.command(name="rate", description="Rate a movie (0-5 stars)")
@app_commands.describe(movie="Movie title", rating="Rating 0-5")
async def rate_movie(interaction: discord.Interaction, movie: str, rating: app_commands.Range[float, 0.0, 5.0]):
    await interaction.response.defer()
    
    # Fetch movie details from TMDb
    movie_data = fetch_movie_details(movie)
    if not movie_data:
        await interaction.followup.send("❌ No movie found matching that title.", ephemeral=True)
        return
    
    # Open sheets
    spreadsheet = client.open("Movie Reviews")  # Change to your sheet name
    watchlist_sheet = spreadsheet.worksheet("Watchlist")  # Watchlist tab
    reviews_sheet = spreadsheet.worksheet("Sheet1")  # Reviews tab
    
    # Check watchlist with fuzzy matching
    watchlist_data = watchlist_sheet.get_all_values()
    is_on_watchlist, match_title, confidence = check_watchlist_fuzzy(movie_data['title'], watchlist_data)
    
    if is_on_watchlist:
        await interaction.followup.send(
            f"⚠️ **'{movie_data['title']}'** already on watchlist as **'{match_title.title()}'** (confidence: {int(confidence)}%)", 
            ephemeral=True
        )
        return
    
    # Log to reviews sheet
    reviews_sheet.append_row([
        movie_data['title'],
        movie_data['release_year'],
        rating,
        movie_data['age_rating'],
        movie_data['directors'],
        movie_data['actors'],
        interaction.user.display_name,
        datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    ])
    
    await interaction.followup.send(
        f"✅ **{movie_data['title']}** ({movie_data['release_year']}) rated **{rating}/5** "
        f"(Age Rating: {movie_data['age_rating']})\n"
        f"**Directors:** {movie_data['directors']}\n"
        f"**Actors:** {movie_data['actors']}\n\n"
        f"Recorded in your Google Sheet!"
    )

@bot.tree.command(name="watchlist", description="Add movie to watchlist")
@app_commands.describe(movie="Movie to add to watchlist")
async def add_watchlist(interaction: discord.Interaction, movie: str):
    await interaction.response.defer()
    
    movie_data = fetch_movie_details(movie)
    if not movie_data:
        await interaction.followup.send("❌ No movie found matching that title.", ephemeral=True)
        return
    
    spreadsheet = client.open("Movie Reviews")
    watchlist_sheet = spreadsheet.worksheet("Watchlist")
    
    watchlist_data = watchlist_sheet.get_all_values()
    is_on_watchlist, match_title, confidence = check_watchlist_fuzzy(movie_data['title'], watchlist_data)
    
    if is_on_watchlist:
        await interaction.followup.send(
            f"✅ **'{movie_data['title']}'** already on watchlist as **'{match_title.title()}'**!", 
            ephemeral=True
        )
        return
    
    # Add to watchlist
    watchlist_sheet.append_row([movie_data['title'], datetime.now().strftime("%Y-%m-%d")])
    await interaction.followup.send(f"✅ **{movie_data['title']}** added to watchlist!")

bot.run(DISCORD_BOT_TOKEN)
