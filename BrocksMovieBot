import discord
from discord import app_commands
from discord.ext import commands
from discord.ui import Select, View
import requests
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import os
from rapidfuzz import fuzz, process

# ======== Configuration ========
DISCORD_BOT_TOKEN = os.getenv('DISCORD_BOT_TOKEN')
TMDB_API_KEY = os.getenv('TMDB_API_KEY')
GOOGLE_CREDS_FILE = 'google-creds.json'
GOOGLE_SHEET_NAME = 'Brocks Movie Review'

# ======== Setup Google Sheets ========
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name(GOOGLE_CREDS_FILE, scope)
client = gspread.authorize(creds)

def fetch_movie_details(title):
    """Fuzzy search TMDb + popularity ranking"""
    search_url = f"https://api.themoviedb.org/3/search/movie?api_key={TMDB_API_KEY}&query={title.replace(' ', '%20')}&language=en-US"
    response = requests.get(search_url)
    
    if response.status_code != 200:
        return None
    
    movies = response.json().get('results', [])
    if not movies:
        return None
    
    scored_results = []
    for movie in movies:
        similarity = fuzz.ratio(title.lower(), movie.get('title', '').lower())
        popularity = movie.get('popularity', 0)
        score = similarity * 0.7 + popularity * 30
        scored_results.append((score, movie))
    
    scored_results.sort(reverse=True)
    return scored_results[:5]

def get_movie_details(movie_id):
    """YOUR ORIGINAL WORKING VERSION + 2 genres + runtime fix"""
    detail_url = f"https://api.themoviedb.org/3/movie/{movie_id}?api_key={TMDB_API_KEY}&language=en-US&append_to_response=credits,release_dates"
    response = requests.get(detail_url)
    
    if response.status_code != 200:
        return None
    
    details = response.json()
    
    # YOUR ORIGINAL WORKING AGE RATING
    age_rating = 'N/A'
    release_dates = details.get('release_dates', {}).get('results', [])
    for date_info in release_dates:
        if date_info.get('iso_3166_1') == 'US':
            certification = date_info.get('certification', '')
            if certification:
                age_rating = certification
                break
    
    # Directors/actors/genres - MAX 2 GENRES
    directors = [crew['name'] for crew in details.get('credits', {}).get('crew', []) if crew['job'] == 'Director'][:2]
    actors = [cast['name'] for cast in details.get('credits', {}).get('cast', [])][:3]
    genres = [genre['name'] for genre in details.get('genres', [])][:2]  # MAX 2!
    
    # Runtime HH:MM
    runtime_min = details.get('runtime', 0)
    runtime = f"{runtime_min//60}:{runtime_min%60:02d}" if runtime_min > 0 else 'N/A'
    
    return {
        'title': details.get('title'),
        'release_year': details.get('release_date', '')[:4],
        'age_rating': age_rating,
        'directors': ', '.join(directors) or 'N/A',
        'actors': ', '.join(actors) or 'N/A',
        'runtime': runtime,
        'genres': ', '.join(genres) or 'N/A'
    }

def check_watchlist_fuzzy(movie_title, watchlist_data):
    titles = [row[0].strip().lower() for row in watchlist_data[1:] if row and row[0]]
    if not titles:
        return False, None, 0
    best_match, score, _ = process.extractOne(movie_title.lower(), titles, scorer=fuzz.ratio)
    return score > 85, best_match, score

# Global client for sheets
ratings_sheet = client.open(GOOGLE_SHEET_NAME).worksheet("Ratings")
watchlist_sheet = client.open(GOOGLE_SHEET_NAME).worksheet("Watchlists")

intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix='!', intents=intents)

@bot.event
async def on_ready():
    print(f'{bot.user} has logged in!')
    try:
        synced = await bot.tree.sync()
        print(f'Synced {len(synced)} command(s)')
    except Exception as e:
        print(f'Failed to sync: {e}')

class MovieSelectView(View):
    def __init__(self, movie_options, interaction, rating=None, is_watchlist=False):
        super().__init__(timeout=60)
        self.movie_options = movie_options
        self.interaction = interaction
        self.rating = rating
        self.is_watchlist = is_watchlist
        self.selected_movie = None
        
        options = [discord.SelectOption(
            label=f"{m['title']} ({m.get('release_date', '')[:4]})",
            value=str(m['id'])
        ) for _, m in movie_options[:5]]
        
        select = Select(placeholder="Choose a movie...", min_values=1, max_values=1, options=options)
        select.callback = self.movie_callback
        self.add_item(select)

    async def movie_callback(self, interaction: discord.Interaction):
        await interaction.response.defer()
        selected_id = int(interaction.data['values'][0])
        self.selected_movie = next(movie for _, movie in self.movie_options if str(movie['id']) == selected_id)
        self.stop()

@bot.tree.command(name="rate", description="Rate a movie (0-5 stars)")
@app_commands.describe(movie="Movie title", rating="Rating 0-5")
async def rate_movie(interaction: discord.Interaction, movie: str, rating: app_commands.Range[float, 0.0, 5.0]):
    await interaction.response.defer()
    
    movie_options = fetch_movie_details(movie)
    if not movie_options:
        await interaction.followup.send("❌ No movie found.", ephemeral=True)
        return
    
    # Single good match
    best_score, best_movie = movie_options[0]
    if best_score > 90 and len(movie_options) == 1:
        movie_data = get_movie_details(best_movie['id'])
        if movie_data:
            # Check watchlist
            watchlist_data = watchlist_sheet.get_all_values()
            if check_watchlist_fuzzy(movie_data['title'], watchlist_data)[0]:
                await interaction.followup.send(f"⚠️ **{movie_data['title']}** already on watchlist!", ephemeral=True)
                return
            
            # PERFECT 9-COLUMN RATINGS
            ratings_sheet.append_row([
                movie_data['title'],      # A: Title
                movie_data['genres'],     # B: Genre (max 2)
                rating,                   # C: Rating
                movie_data['runtime'],    # D: Runtime (2:30)
                datetime.now().strftime("%Y-%m-%d"),  # E: Watch Date
                movie_data['release_year'], # F: Release Year
                movie_data['directors'],  # G: Directors
                movie_data['actors'],     # H: Actors
                movie_data['age_rating']  # I: Age Rating - WORKING!
            ])
            await interaction.followup.send(f"✅ **{movie_data['title']}** ({movie_data['age_rating']}) rated {rating}/5!")
        return
    
    # Dropdown
    view = MovieSelectView(movie_options, interaction, rating)
    embed = discord.Embed(title=f"Select {movie}", color=0x00ff00)
    await interaction.followup.send(embed=embed, view=view)
    
    await view.wait()
    if view.selected_movie:
        movie_data = get_movie_details(view.selected_movie['id'])
        if movie_data:
            watchlist_data = watchlist_sheet.get_all_values()
            if not check_watchlist_fuzzy(movie_data['title'], watchlist_data)[0]:
                ratings_sheet.append_row([
                    movie_data['title'],
                    movie_data['genres'],
                    view.rating,
                    movie_data['runtime'],
                    datetime.now().strftime("%Y-%m-%d"),
                    movie_data['release_year'],
                    movie_data['directors'],
                    movie_data['actors'],
                    movie_data['age_rating']
                ])
                embed = discord.Embed(title="✅ Recorded!", color=0x00ff00)
                await interaction.edit_original_response(embed=embed, view=None)

@bot.tree.command(name="watchlist", description="Add to watchlist")
@app_commands.describe(movie="Movie title")
async def watchlist(interaction: discord.Interaction, movie: str):
    await interaction.response.defer()
    
    movie_options = fetch_movie_details(movie)
    if not movie_options:
        await interaction.followup.send("❌ No movie found.", ephemeral=True)
        return
    
    if len(movie_options) == 1 and movie_options[0][0] > 90:
        movie_data = get_movie_details(movie_options[0][1]['id'])
        if movie_data:
            watchlist_data = watchlist_sheet.get_all_values()
            if check_watchlist_fuzzy(movie_data['title'], watchlist_data)[0]:
                await interaction.followup.send(f"✅ **{movie_data['title']}** already on watchlist!", ephemeral=True)
                return
            watchlist_sheet.append_row([movie_data['title'], datetime.now().strftime("%Y-%m-%d")])
            await interaction.followup.send(f"✅ **{movie_data['title']}** added!")
        return
    
    view = MovieSelectView(movie_options, interaction, is_watchlist=True)
    embed = discord.Embed(title="Select movie", color=0x0099ff)
    await interaction.followup.send(embed=embed, view=view)
    
    await view.wait()
    if view.selected_movie:
        movie_data = get_movie_details(view.selected_movie['id'])
        if movie_data:
            watchlist_data = watchlist_sheet.get_all_values()
            if not check_watchlist_fuzzy(movie_data['title'], watchlist_data)[0]:
                watchlist_sheet.append_row([movie_data['title'], datetime.now().strftime("%Y-%m-%d")])
                await interaction.edit_original_response(content=f"✅ **{movie_data['title']}** added!", view=None)

bot.run(DISCORD_BOT_TOKEN)
