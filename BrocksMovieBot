import discord
from discord import app_commands
from discord.ext import commands
import requests
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import os

from rapidfuzz import fuzz

# ======== Configuration ========
DISCORD_BOT_TOKEN = os.getenv('DISCORD_BOT_TOKEN')
TMDB_API_KEY = os.getenv('TMDB_API_KEY')
GOOGLE_CREDS_FILE = 'google-creds.json'  # Keep this file local, do not push to GitHub!
GOOGLE_SHEET_NAME = 'Brocks Movie Review'

# ======== Setup Google Sheets client ========
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name(GOOGLE_CREDS_FILE, scope)
client = gspread.authorize(creds)
sheet = client.open(GOOGLE_SHEET_NAME).sheet1

# ======== Define bot class with intents ========
class MyBot(commands.Bot):
    def __init__(self):
        intents = discord.Intents.default()
        intents.message_content = True
        super().__init__(command_prefix="!", intents=intents)

    async def setup_hook(self):
        # Sync the command tree to register slash commands
        await self.tree.sync()

bot = MyBot()

# ======== Improved fetch movie details with fuzzy matching and age rating ========
def fetch_movie_details(title):
    search_url = f"https://api.themoviedb.org/3/search/movie?api_key={TMDB_API_KEY}&query={title}"
    response = requests.get(search_url).json()
    results = response.get('results', [])

    if not results:
        return None, None

    # Use fuzzy matching to find closest title match
    scored_results = []
    lower_title = title.lower()

    for movie in results:
        candidate_title = movie.get('title', '').lower()
        score = fuzz.ratio(lower_title, candidate_title)
        scored_results.append((score, movie))

    # Sort descending by score
    scored_results.sort(key=lambda x: x[0], reverse=True)

    # If top score is low, return multiple options for clarification
    if scored_results[0][0] < 70:  # threshold 70 can be tuned
        # return none and list of options
        options = [(m['title'], m.get('release_date', '')[:4]) for s,m in scored_results[:5]]
        return None, options

    # Use top scored movie
    movie = scored_results[0][1]
    movie_id = movie['id']

    # Get detailed movie info with credits and release dates (for age rating)
    details_url = f"https://api.themoviedb.org/3/movie/{movie_id}?api_key={TMDB_API_KEY}&append_to_response=credits,release_dates"
    details = requests.get(details_url).json()

    genres = ', '.join([g['name'] for g in details.get('genres', [])])
    runtime = details.get('runtime', 'N/A')
    release_year = details.get('release_date', '')[:4]
    directors = [c['name'] for c in details['credits']['crew'] if c['job'] == 'Director']
    actors = [a['name'] for a in details['credits']['cast'][:3]]

    # Get US age certification
    certification = 'N/A'
    release_dates_data = details.get('release_dates', {}).get('results', [])
    for country_info in release_dates_data:
        if country_info.get('iso_3166_1') == 'US':
            for release in country_info.get('release_dates', []):
                if release.get('certification'):
                    certification = release['certification']
                    break
            if certification != 'N/A':
                break

    return {
        'title': details.get('title', 'N/A'),
        'genre': genres,
        'runtime': runtime,
        'release_year': release_year,
        'directors': ', '.join(directors) if directors else 'N/A',
        'actors': ', '.join(actors) if actors else 'N/A',
        'age_rating': certification
    }, None

# ======== Slash command to rate a movie ========
@bot.tree.command(name="rate", description="Rate a movie")
@app_commands.describe(title="Movie title to rate", rating="Rating from 0 to 5")
async def rate_command(interaction: discord.Interaction, title: str, rating: float):
    if rating < 0 or rating > 5:
        await interaction.response.send_message("Please provide a rating between 0 and 5.", ephemeral=True)
        return

    await interaction.response.defer()  # Acknowledge the command

    movie, options = fetch_movie_details(title)
    if options:
        # Multiple possible movies found, ask user to specify
        msg_options = "\n".join([f"{idx+1}. {opt[0]} ({opt[1]})" for idx, opt in enumerate(options)])
        await interaction.followup.send(f"Multiple movies match your query. Please be more specific or select one:\n{msg_options}")
        return

    if not movie:
        await interaction.followup.send(f"Sorry, could not find movie '{title}'.")
        return

    watch_date = datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')

    sheet.append_row([
        movie['title'],
        movie['genre'],
        rating,
        movie['runtime'],
        watch_date,
        movie['release_year'],
        movie['directors'],
        movie['actors'],
        movie['age_rating']
    ])

    await interaction.followup.send(f"Your rating of {rating}/5 for '{movie['title']}' (Age Rating: {movie['age_rating']}) has been recorded!")

# ======== Run the bot ========
bot.run(DISCORD_BOT_TOKEN)
